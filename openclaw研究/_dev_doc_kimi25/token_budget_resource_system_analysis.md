# OpenClaw Token èµ„æºé¢„ç®—ç³»ç»Ÿåˆ†æ

> æ·±åº¦ç ”ç©¶ OpenClaw çš„ Token ä½¿ç”¨æ˜¯å¦å¯ä»¥å»ºæ¨¡ä¸ºèµ„æºé¢„ç®—ç³»ç»Ÿï¼ŒåŒ…æ‹¬ per-task budgetã€cost profiling å’Œ FinOps ç®¡æ§èƒ½åŠ›

---

## ä¸€ã€å½“å‰ Token ç®¡ç†ä½“ç³»

### 1.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OpenClaw Token ç®¡ç†ä½“ç³»æ¶æ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        æ¨¡å‹å±‚ (Model Layer)                                  â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   ModelDefinitionConfig:                                                     â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ contextWindow: number     (ä¸Šä¸‹æ–‡çª—å£ä¸Šé™)                              â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ maxTokens: number         (å•æ¬¡ç”Ÿæˆä¸Šé™)                                â”‚   â”‚
â”‚   â”‚   â””â”€â”€ cost: { input, output, cacheRead, cacheWrite }  (æˆæœ¬é…ç½®)              â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   æ–‡ä»¶: config/types.models.ts                                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                                 â”‚
â”‚                                    â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        ä½¿ç”¨è¿½è¸ªå±‚ (Usage Tracking)                           â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   UsageLike (åŸå§‹æ•°æ®):                                                      â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ input/output/cacheRead/cacheWrite                                     â”‚   â”‚
â”‚   â”‚   â””â”€â”€ total                                                                 â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   NormalizedUsage (æ ‡å‡†åŒ–):                                                  â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ç»Ÿä¸€æ ¼å¼ï¼Œæ”¯æŒå¤šç§ Provider                                            â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   æ–‡ä»¶: agents/usage.ts                                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                                 â”‚
â”‚                                    â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        æˆæœ¬è®¡ç®—å±‚ (Cost Calculation)                         â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   ModelCostConfig:                                                           â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ input/output/cacheRead/cacheWrite (per 1M tokens)                     â”‚   â”‚
â”‚   â”‚   â””â”€â”€ estimateUsageCost(): è®¡ç®—å•æ¬¡ä½¿ç”¨æˆæœ¬                                 â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   æ–‡ä»¶: utils/usage-format.ts                                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                                 â”‚
â”‚                                    â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        èšåˆåˆ†æå±‚ (Aggregation)                              â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   SessionCostSummary:                                                        â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ æŒ‰ä¼šè¯ç»Ÿè®¡ token/cost                                                 â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ æŒ‰å¤©èšåˆ (daily breakdown)                                            â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ (model usage)                                            â”‚   â”‚
â”‚   â”‚   â””â”€â”€ å»¶è¿Ÿç»Ÿè®¡ (latency stats)                                              â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   ProviderUsageSummary:                                                      â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ä» Provider API è·å–å®é™…è´¦å•æ•°æ®                                      â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   æ–‡ä»¶: infra/session-cost-usage.ts, infra/provider-usage.ts               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                                 â”‚
â”‚                                    â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        å­˜å‚¨å±‚ (Persistence)                                  â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   Session æ–‡ä»¶ (JSON Lines):                                                 â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ type: "message" + usage è®°å½•                                          â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ type: "usage" ç‹¬ç«‹è®°å½•                                                â”‚   â”‚
â”‚   â”‚   â””â”€â”€ åŒ…å« cost breakdown (å¦‚æœ Provider è¿”å›)                              â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   ä½ç½®: ~/.openclaw/sessions/{agentId}/{sessionId}.jsonl                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ•°æ®ç»“æ„

```typescript
// config/types.models.ts
interface ModelDefinitionConfig {
  id: string;
  name: string;
  contextWindow: number;        // ä¸Šä¸‹æ–‡çª—å£ä¸Šé™ (å¦‚ 200000)
  maxTokens: number;            // å•æ¬¡ç”Ÿæˆä¸Šé™ (å¦‚ 8192)
  cost: {
    input: number;              // $ per 1M input tokens
    output: number;             // $ per 1M output tokens
    cacheRead: number;          // $ per 1M cache read tokens
    cacheWrite: number;         // $ per 1M cache write tokens
  };
}

// agents/usage.ts
interface NormalizedUsage {
  input?: number;               // Input tokens
  output?: number;              // Output tokens
  cacheRead?: number;           // Cache read tokens
  cacheWrite?: number;          // Cache write tokens
  total?: number;               // Total tokens
}

// infra/session-cost-usage.types.ts
interface CostUsageTotals {
  input: number;
  output: number;
  cacheRead: number;
  cacheWrite: number;
  totalTokens: number;
  totalCost: number;
  inputCost: number;
  outputCost: number;
  cacheReadCost: number;
  cacheWriteCost: number;
  missingCostEntries: number;
}

interface SessionCostSummary extends CostUsageTotals {
  sessionId?: string;
  dailyBreakdown?: SessionDailyUsage[];      // æŒ‰å¤©ç»Ÿè®¡
  dailyMessageCounts?: SessionDailyMessageCounts[];
  dailyLatency?: SessionDailyLatency[];      // å»¶è¿Ÿç»Ÿè®¡
  dailyModelUsage?: SessionDailyModelUsage[]; // æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ
  messageCounts?: SessionMessageCounts;
  toolUsage?: SessionToolUsage;              // å·¥å…·ä½¿ç”¨ç»Ÿè®¡
  modelUsage?: SessionModelUsage[];
  latency?: SessionLatencyStats;
}
```

---

## äºŒã€Per-Task Budget æ”¯æŒåˆ†æ

### 2.1 å½“å‰ Budget æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å½“å‰ Budget æœºåˆ¶åˆ†æ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   å­˜åœ¨çš„ Budget æ§åˆ¶:                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  1. ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ (Context Window Limit)                                    â”‚   â”‚
â”‚   â”‚     â”œâ”€â”€ æ¨¡å‹çº§: ModelDefinitionConfig.contextWindow                         â”‚   â”‚
â”‚   â”‚     â”œâ”€â”€ åŠ¨æ€è®¡ç®—: lookupContextTokens(modelId)                              â”‚   â”‚
â”‚   â”‚     â””â”€â”€ å‹ç¼©è§¦å‘: å½“å†å²è¶…è¿‡ maxHistoryShare (é»˜è®¤ 50%) æ—¶è§¦å‘               â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  2. å•æ¬¡ç”Ÿæˆé•¿åº¦é™åˆ¶ (Max Tokens Limit)                                      â”‚   â”‚
â”‚   â”‚     â”œâ”€â”€ æ¨¡å‹çº§: ModelDefinitionConfig.maxTokens                             â”‚   â”‚
â”‚   â”‚     â””â”€â”€ è¿è¡Œæ—¶: é€šè¿‡ API å‚æ•°ä¼ é€’ç»™ Provider                                â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  3. å†å²æ¶ˆæ¯é™åˆ¶ (History Limit)                                             â”‚   â”‚
â”‚   â”‚     â”œâ”€â”€ maxHistoryTurns: é™åˆ¶ä¿ç•™çš„æ¶ˆæ¯è½®æ•°                                 â”‚   â”‚
â”‚   â”‚     â””â”€â”€ maxHistoryShare: é™åˆ¶å†å²å ä¸Šä¸‹æ–‡çš„æ¯”ä¾‹                             â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  4. å›¾åƒå¤§å°é™åˆ¶ (Image Budget)                                              â”‚   â”‚
â”‚   â”‚     â””â”€â”€ MAX_IMAGE_BYTES: å›¾åƒæ–‡ä»¶å¤§å°ä¸Šé™                                   â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚   ç¼ºå¤±çš„ Budget æ§åˆ¶:                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  âŒ 1. Per-Task Token Budget                                                 â”‚   â”‚
â”‚   â”‚     â””â”€â”€ æ— æ³•ä¸ºå•ä¸ªä»»åŠ¡è®¾ç½® token ä¸Šé™                                       â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  âŒ 2. Per-Session Cost Budget                                               â”‚   â”‚
â”‚   â”‚     â””â”€â”€ æ— æ³•ä¸ºä¼šè¯è®¾ç½®æˆæœ¬ä¸Šé™                                             â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  âŒ 3. Daily/Monthly Budget Cap                                              â”‚   â”‚
â”‚   â”‚     â””â”€â”€ æ— æ³•è®¾ç½®å‘¨æœŸæ€§é¢„ç®—ä¸Šé™                                             â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  âŒ 4. Per-User Budget Quota                                                 â”‚   â”‚
â”‚   â”‚     â””â”€â”€ æ— æ³•ä¸ºç”¨æˆ·åˆ†é…é¢„ç®—é…é¢                                             â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â”‚  âŒ 5. Tool Call Budget                                                      â”‚   â”‚
â”‚   â”‚     â””â”€â”€ æ— æ³•é™åˆ¶å·¥å…·è°ƒç”¨æ¬¡æ•°æˆ–æˆæœ¬                                         â”‚   â”‚
â”‚   â”‚                                                                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å…³é”®ä»£ç åˆ†æ

```typescript
// agents/compaction.ts
// ä¸Šä¸‹æ–‡å‹ç¼©è§¦å‘é€»è¾‘

export function computeAdaptiveChunkRatio(
  messages: AgentMessage[], 
  contextWindow: number
): number {
  const totalTokens = estimateMessagesTokens(messages);
  const avgTokens = totalTokens / messages.length;
  
  // å®‰å…¨è¾¹è· 20%
  const safeAvgTokens = avgTokens * SAFETY_MARGIN; // SAFETY_MARGIN = 1.2
  const avgRatio = safeAvgTokens / contextWindow;

  // å¦‚æœå¹³å‡æ¶ˆæ¯ > 10% ä¸Šä¸‹æ–‡ï¼Œé™ä½åˆ†å—æ¯”ä¾‹
  if (avgRatio > 0.1) {
    const reduction = Math.min(avgRatio * 2, BASE_CHUNK_RATIO - MIN_CHUNK_RATIO);
    return Math.max(MIN_CHUNK_RATIO, BASE_CHUNK_RATIO - reduction);
  }
  return BASE_CHUNK_RATIO;
}

// pi-extensions/compaction-safeguard.ts
// å®‰å…¨ä¿æŠ¤ï¼šæ–°å†…å®¹å æ¯”è¿‡é«˜æ—¶ä¸»åŠ¨è£å‰ª

export default function compactionSafeguardExtension(api: ExtensionAPI): void {
  api.on("session_before_compact", async (event, ctx) => {
    const maxHistoryTokens = Math.floor(
      contextWindowTokens * maxHistoryShare * SAFETY_MARGIN
    );
    
    // å¦‚æœæ–°å†…å®¹è¶…è¿‡å†å²é¢„ç®—ï¼Œä¸»åŠ¨è£å‰ª
    if (newContentTokens > maxHistoryTokens) {
      const pruned = pruneHistoryForContextShare({
        messages: messagesToSummarize,
        maxContextTokens: contextWindowTokens,
        maxHistoryShare,  // é»˜è®¤ 0.5 (50%)
        parts: 2,
      });
    }
  });
}
```

### 2.3 Per-Task Budget å®ç°å»ºè®®

```typescript
// ç†è®ºä¸Šçš„ Per-Task Budget ç³»ç»Ÿ

interface TaskBudgetConfig {
  // Token é¢„ç®—
  maxInputTokens?: number;      // è¾“å…¥ token ä¸Šé™
  maxOutputTokens?: number;     // è¾“å‡º token ä¸Šé™
  maxTotalTokens?: number;      // æ€» token ä¸Šé™
  
  // æˆæœ¬é¢„ç®—
  maxCostUsd?: number;          // æˆæœ¬ä¸Šé™ (USD)
  
  // å·¥å…·é¢„ç®—
  maxToolCalls?: number;        // å·¥å…·è°ƒç”¨æ¬¡æ•°ä¸Šé™
  maxToolCostUsd?: number;      // å·¥å…·è°ƒç”¨æˆæœ¬ä¸Šé™
  
  // æ—¶é—´é¢„ç®—
  maxDurationMs?: number;       // æ‰§è¡Œæ—¶é—´ä¸Šé™
  
  // ç­–ç•¥
  onBudgetExceeded: 'abort' | 'warn' | 'compact' | 'switch-model';
}

interface TaskBudgetTracker {
  config: TaskBudgetConfig;
  
  // å½“å‰ä½¿ç”¨
  usedInputTokens: number;
  usedOutputTokens: number;
  usedTotalTokens: number;
  usedCostUsd: number;
  usedToolCalls: number;
  startTime: number;
  
  // æ£€æŸ¥é¢„ç®—
  checkBudget(): BudgetStatus;
  
  // è®°å½•ä½¿ç”¨
  recordUsage(usage: NormalizedUsage, cost?: number): void;
  recordToolCall(toolName: string): void;
  
  // é¢„ç®—Exceededå¤„ç†
  handleBudgetExceeded(): Promise<BudgetAction>;
}

// é›†æˆåˆ° Agent Loop
class BudgetAwareAgentLoop {
  constructor(private budgetTracker: TaskBudgetTracker) {}
  
  async runTurn(): Promise<AgentTurnResult> {
    // æ£€æŸ¥é¢„ç®—
    const status = this.budgetTracker.checkBudget();
    if (status.exceeded) {
      return this.budgetTracker.handleBudgetExceeded();
    }
    
    // æ‰§è¡Œ turn
    const result = await this.executeTurn();
    
    // è®°å½•ä½¿ç”¨
    this.budgetTracker.recordUsage(result.usage, result.cost);
    
    return result;
  }
}
```

---

## ä¸‰ã€Cost Profiling èƒ½åŠ›åˆ†æ

### 3.1 å½“å‰ Cost Profiling åŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Cost Profiling èƒ½åŠ›çŸ©é˜µ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   åŠŸèƒ½                              â”‚ æ”¯æŒåº¦ â”‚ è¯´æ˜                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   å•æ¬¡ä½¿ç”¨æˆæœ¬è®¡ç®—                   â”‚   âœ…   â”‚ estimateUsageCost()                  â”‚
â”‚   ä¼šè¯çº§æˆæœ¬èšåˆ                     â”‚   âœ…   â”‚ SessionCostSummary                   â”‚
â”‚   æŒ‰å¤©æˆæœ¬èšåˆ                       â”‚   âœ…   â”‚ dailyBreakdown                       â”‚
â”‚   æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ                       â”‚   âœ…   â”‚ modelUsage                           â”‚
â”‚   å·¥å…·ä½¿ç”¨ç»Ÿè®¡                       â”‚   âœ…   â”‚ toolUsage                            â”‚
â”‚   å»¶è¿Ÿç»Ÿè®¡                           â”‚   âœ…   â”‚ latency stats                        â”‚
â”‚   Provider API è´¦å•å¯¹æ¯”              â”‚   âœ…   â”‚ provider-usage.ts                    â”‚
â”‚   æŒ‰ç”¨æˆ·æˆæœ¬åˆ†æ                     â”‚   âŒ   â”‚ ä¸æ”¯æŒ                               â”‚
â”‚   æŒ‰ä»»åŠ¡ç±»å‹æˆæœ¬åˆ†æ                 â”‚   âŒ   â”‚ ä¸æ”¯æŒ                               â”‚
â”‚   æˆæœ¬é¢„æµ‹/é¢„ç®—å‘Šè­¦                  â”‚   âŒ   â”‚ ä¸æ”¯æŒ                               â”‚
â”‚   æˆæœ¬å¼‚å¸¸æ£€æµ‹                       â”‚   âŒ   â”‚ ä¸æ”¯æŒ                               â”‚
â”‚   å®æ—¶æˆæœ¬æµ                         â”‚   âš ï¸   â”‚ ä»…æ”¯æŒäº‹ä»¶å‘å°„ï¼Œæ— å®æ—¶ä»ªè¡¨ç›˜         â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æˆæœ¬åˆ†æä»£ç ç¤ºä¾‹

```typescript
// infra/session-cost-usage.ts
// ä¼šè¯æˆæœ¬åˆ†æ

export async function loadCostUsageSummary(params?: {
  startMs?: number;
  endMs?: number;
  days?: number;
  config?: OpenClawConfig;
  agentId?: string;
}): Promise<CostUsageSummary> {
  const dailyMap = new Map<string, CostUsageTotals>();
  const totals = emptyTotals();

  // æ‰«ææ‰€æœ‰ session æ–‡ä»¶
  for (const filePath of sessionFiles) {
    await scanUsageFile({
      filePath,
      config: params?.config,
      onEntry: (entry) => {
        const dayKey = formatDayKey(entry.timestamp ?? now);
        const bucket = dailyMap.get(dayKey) ?? emptyTotals();
        
        // ç´¯åŠ  usage
        applyUsageTotals(bucket, entry.usage);
        
        // ç´¯åŠ  cost
        if (entry.costBreakdown?.total !== undefined) {
          applyCostBreakdown(bucket, entry.costBreakdown);
        }
        
        dailyMap.set(dayKey, bucket);
      },
    });
  }

  return {
    updatedAt: Date.now(),
    days,
    daily: Array.from(dailyMap.entries()).map(([date, bucket]) => ({
      date,
      ...bucket,
    })),
    totals,
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const summary = await loadCostUsageSummary({
  days: 30,
  agentId: 'my-agent',
});

console.log(`Total cost: $${summary.totals.totalCost.toFixed(2)}`);
console.log(`Daily average: $${(summary.totals.totalCost / summary.days).toFixed(2)}`);
```

### 3.3 Provider è´¦å•å¯¹æ¯”

```typescript
// infra/provider-usage.load.ts
// ä» Provider API è·å–å®é™…è´¦å•

export async function loadProviderUsageSummary(
  opts: UsageSummaryOptions = {}
): Promise<UsageSummary> {
  const auths = await resolveProviderAuths({...});
  
  const tasks = auths.map((auth) => {
    switch (auth.provider) {
      case "anthropic":
        return fetchClaudeUsage(auth.token, timeoutMs, fetchFn);
      case "github-copilot":
        return fetchCopilotUsage(auth.token, timeoutMs, fetchFn);
      case "google-gemini-cli":
        return fetchGeminiUsage(auth.token, timeoutMs, fetchFn);
      case "openai-codex":
        return fetchCodexUsage(auth.token, auth.accountId, timeoutMs, fetchFn);
      // ... å…¶ä»– providers
    }
  });

  const snapshots = await Promise.all(tasks);
  
  return {
    updatedAt: now,
    providers: snapshots,
  };
}

// å¯¹æ¯”æœ¬åœ°è®°å½•å’Œ Provider è´¦å•
function reconcileCosts(
  localSummary: CostUsageSummary,
  providerSummary: UsageSummary
): CostReconciliationReport {
  return {
    localTotal: localSummary.totals.totalCost,
    providerTotal: calculateProviderTotal(providerSummary),
    discrepancy: calculateDiscrepancy(localSummary, providerSummary),
    unmatchedSessions: findUnmatchedSessions(localSummary, providerSummary),
  };
}
```

---

## å››ã€FinOps ç®¡æ§å¯è¡Œæ€§åˆ†æ

### 4.1 FinOps èƒ½åŠ›æˆç†Ÿåº¦è¯„ä¼°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FinOps èƒ½åŠ›æˆç†Ÿåº¦æ¨¡å‹                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   ç»´åº¦                          â”‚ å½“å‰çº§åˆ« â”‚ ç›®æ ‡çº§åˆ« â”‚ å·®è·                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   æˆæœ¬å¯è§æ€§ (Visibility)       â”‚   L3     â”‚   L4     â”‚ ç¼ºå°‘å®æ—¶ä»ªè¡¨ç›˜            â”‚
â”‚   æˆæœ¬åˆ†é… (Allocation)         â”‚   L2     â”‚   L4     â”‚ ç¼ºå°‘ç”¨æˆ·/ä»»åŠ¡ç»´åº¦         â”‚
â”‚   é¢„ç®—ç®¡ç† (Budgeting)          â”‚   L1     â”‚   L4     â”‚ æ— é¢„ç®—æ§åˆ¶æœºåˆ¶            â”‚
â”‚   æˆæœ¬ä¼˜åŒ– (Optimization)       â”‚   L2     â”‚   L3     â”‚ ä»…åŸºç¡€å‹ç¼©ç­–ç•¥            â”‚
â”‚   æˆæœ¬é¢„æµ‹ (Forecasting)        â”‚   L0     â”‚   L3     â”‚ æ— é¢„æµ‹èƒ½åŠ›                â”‚
â”‚   å¼‚å¸¸æ£€æµ‹ (Anomaly Detection)  â”‚   L0     â”‚   L3     â”‚ æ— å¼‚å¸¸æ£€æµ‹                â”‚
â”‚   è‡ªåŠ¨åŒ– (Automation)           â”‚   L1     â”‚   L4     â”‚ æ— è‡ªåŠ¨ä¼˜åŒ–                â”‚
â”‚                                                                                      â”‚
â”‚   æˆç†Ÿåº¦çº§åˆ«å®šä¹‰:                                                                     â”‚
â”‚   L0 - æ— : å®Œå…¨æ²¡æœ‰è¯¥èƒ½åŠ›                                                            â”‚
â”‚   L1 - åŸºç¡€: åŸå§‹æ•°æ®å¯ç”¨ï¼Œæ— ç»“æ„åŒ–åˆ†æ                                               â”‚
â”‚   L2 - å‘å±•: åŸºç¡€æŠ¥å‘Šå’Œèšåˆ                                                          â”‚
â”‚   L3 - æˆç†Ÿ: å¤šç»´åº¦åˆ†æå’Œå¯è§†åŒ–                                                       â”‚
â”‚   L4 - ä¼˜åŒ–: é¢„æµ‹ã€è‡ªåŠ¨åŒ–å’ŒæŒç»­ä¼˜åŒ–                                                   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 FinOps åŠŸèƒ½å®ç°å»ºè®®

```typescript
// ç†è®ºä¸Šçš„ FinOps ç®¡æ§ç³»ç»Ÿ

// 1. é¢„ç®—ç®¡ç† (Budget Management)
interface BudgetPolicy {
  // å…¨å±€é¢„ç®—
  globalDailyBudgetUsd?: number;
  globalMonthlyBudgetUsd?: number;
  
  // æŒ‰ç»´åº¦é¢„ç®—
  perUserBudgetUsd?: number;
  perSessionBudgetUsd?: number;
  perTaskBudgetUsd?: number;
  
  // å‘Šè­¦é˜ˆå€¼
  warningThreshold: number;  // å¦‚ 0.8 (80%)
  criticalThreshold: number; // å¦‚ 0.95 (95%)
  
  // è¶…é™ç­–ç•¥
  onExceed: 'notify' | 'throttle' | 'block' | 'downgrade-model';
}

// 2. æˆæœ¬é¢„æµ‹ (Cost Forecasting)
interface CostForecaster {
  // åŸºäºå†å²æ•°æ®é¢„æµ‹
  forecastDailyCost(days: number): Promise<CostForecast>;
  forecastMonthlyCost(): Promise<CostForecast>;
  
  // é¢„æµ‹å‰©ä½™é¢„ç®—å¯ç”¨å¤©æ•°
  predictBudgetExhaustion(budgetUsd: number): Promise<number>;
  
  // å¼‚å¸¸æ£€æµ‹
  detectAnomalies(): Promise<CostAnomaly[]>;
}

interface CostForecast {
  predictedCost: number;
  confidenceInterval: [number, number];
  trend: 'increasing' | 'decreasing' | 'stable';
  factors: CostFactor[];
}

// 3. æˆæœ¬ä¼˜åŒ–å»ºè®® (Cost Optimization)
interface CostOptimizer {
  // åˆ†æä¼˜åŒ–æœºä¼š
  analyzeOptimizationOpportunities(): Promise<OptimizationOpportunity[]>;
  
  // è‡ªåŠ¨ä¼˜åŒ–
  applyOptimization(opportunity: OptimizationOpportunity): Promise<void>;
  
  // æ¨¡å‹é™çº§å»ºè®®
  suggestModelDowngrade(
    currentUsage: UsagePattern
  ): Promise<ModelDowngradeSuggestion | null>;
}

interface OptimizationOpportunity {
  type: 'model-downgrade' | 'cache-optimization' | 'batching' | 'prompt-optimization';
  potentialSavingsUsd: number;
  confidence: number;
  action: () => Promise<void>;
}

// 4. å®æ—¶æˆæœ¬æµ (Real-time Cost Streaming)
interface CostEventStream {
  // å‘å°„æˆæœ¬äº‹ä»¶
  emit(event: CostEvent): void;
  
  // è®¢é˜…æˆæœ¬äº‹ä»¶
  subscribe(handler: (event: CostEvent) => void): () => void;
  
  // èšåˆçª—å£
  windowedAggregate(windowMs: number): Observable<CostAggregate>;
}

interface CostEvent {
  timestamp: number;
  sessionId: string;
  userId?: string;
  taskType?: string;
  usage: NormalizedUsage;
  costUsd: number;
  model: string;
  provider: string;
}
```

### 4.3 FinOps ä»ªè¡¨ç›˜è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å»ºè®®çš„ FinOps ä»ªè¡¨ç›˜                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  å®æ—¶æŒ‡æ ‡ (Real-time Metrics)                                                â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚   â”‚  â”‚ ä»Šæ—¥æˆæœ¬    â”‚  â”‚ æœ¬æœˆæˆæœ¬    â”‚  â”‚ æ´»è·ƒä¼šè¯    â”‚  â”‚ é¢„ç®—å‰©ä½™    â”‚        â”‚   â”‚
â”‚   â”‚  â”‚ $123.45     â”‚  â”‚ $3,456.78   â”‚  â”‚ 12          â”‚  â”‚ 67%         â”‚        â”‚   â”‚
â”‚   â”‚  â”‚ â–² 12%       â”‚  â”‚ â–² 5%        â”‚  â”‚             â”‚  â”‚ é¢„è®¡12å¤©ç”¨å®Œâ”‚        â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  æˆæœ¬è¶‹åŠ¿ (Cost Trends)                                                      â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   Cost                                                                        â”‚   â”‚
â”‚   â”‚   â†‘                                                                           â”‚   â”‚
â”‚   â”‚   â”‚    â•­â”€â•®      â•­â”€â”€â•®                                                        â”‚   â”‚
â”‚   â”‚   â”‚   â•­â•¯ â•°â•®    â•­â•¯  â•°â•®    å®é™…æˆæœ¬                                           â”‚   â”‚
â”‚   â”‚   â”‚  â•­â•¯   â•°â•®â”€â”€â•­â•¯    â•°â”€â”€â”€                                                  â”‚   â”‚
â”‚   â”‚   â”‚ â•­â•¯     â•°â”€â•¯         â”€ â”€ â”€ é¢„æµ‹æˆæœ¬                                      â”‚   â”‚
â”‚   â”‚   â”‚â•­â•¯                                                                      â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Time                                  â”‚   â”‚
â”‚   â”‚        è¿‡å»30å¤©                                                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  æˆæœ¬åˆ†è§£ (Cost Breakdown)    â”‚  å¼‚å¸¸å‘Šè­¦ (Anomalies)                        â”‚   â”‚
â”‚   â”‚                               â”‚                                              â”‚   â”‚
â”‚   â”‚   æŒ‰æ¨¡å‹:                     â”‚   âš ï¸ ç”¨æˆ· user-123 æˆæœ¬çªå¢ 300%             â”‚   â”‚
â”‚   â”‚   - Claude: 45%               â”‚      è¿‡å»1å°æ—¶: $45.67 (å¹³æ—¶: $15)           â”‚   â”‚
â”‚   â”‚   - GPT-4: 30%                â”‚                                              â”‚   â”‚
â”‚   â”‚   - Gemini: 25%               â”‚   âš ï¸ ä¼šè¯ sess-456 å·¥å…·è°ƒç”¨è¿‡å¤š              â”‚   â”‚
â”‚   â”‚                               â”‚      å·¥å…·è°ƒç”¨: 50æ¬¡ (å¹³å‡: 10æ¬¡)             â”‚   â”‚
â”‚   â”‚   æŒ‰ç”¨æˆ·:                     â”‚                                              â”‚   â”‚
â”‚   â”‚   - user-1: $123              â”‚                                              â”‚   â”‚
â”‚   â”‚   - user-2: $89               â”‚                                              â”‚   â”‚
â”‚   â”‚                               â”‚                                              â”‚   â”‚
â”‚   â”‚   æŒ‰å·¥å…·:                     â”‚                                              â”‚   â”‚
â”‚   â”‚   - read: 40%                 â”‚                                              â”‚   â”‚
â”‚   â”‚   - edit: 35%                 â”‚                                              â”‚   â”‚
â”‚   â”‚   - exec: 25%                 â”‚                                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ä¼˜åŒ–å»ºè®® (Optimization Recommendations)                                     â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   ğŸ’¡ å»ºè®®å°† 20% çš„ Claude è°ƒç”¨é™çº§åˆ° Claude-Haiku                            â”‚   â”‚
â”‚   â”‚      é¢„è®¡èŠ‚çœ: $123/æœˆ                                                      â”‚   â”‚
â”‚   â”‚      ç½®ä¿¡åº¦: 85%                                                            â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â”‚   ğŸ’¡ æ£€æµ‹åˆ° 15% çš„é‡å¤æŸ¥è¯¢ï¼Œå»ºè®®å¯ç”¨ç¼“å­˜                                     â”‚   â”‚
â”‚   â”‚      é¢„è®¡èŠ‚çœ: $45/æœˆ                                                       â”‚   â”‚
â”‚   â”‚                                                                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€ç»“è®ºä¸å»ºè®®

### 5.1 æ ¸å¿ƒç»“è®º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ ¸å¿ƒç»“è®º                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   1. Token ä½¿ç”¨æ˜¯å¦å¯ä»¥å»ºæ¨¡ä¸ºèµ„æºé¢„ç®—ç³»ç»Ÿï¼Ÿ                                          â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚      âš ï¸ éƒ¨åˆ†å¯è¡Œ                                                                     â”‚
â”‚      âœ… å·²æœ‰åŸºç¡€: å®Œæ•´çš„ usage è¿½è¸ªã€æˆæœ¬è®¡ç®—ã€èšåˆåˆ†æ                              â”‚
â”‚      âŒ ç¼ºå¤±å…³é”®: é¢„ç®—æ§åˆ¶ã€èµ„æºé…é¢ã€å®æ—¶ç®¡æ§                                       â”‚
â”‚      å½“å‰çŠ¶æ€: è¿½è¸ªç³»ç»Ÿæˆç†Ÿï¼Œä½†ç¼ºä¹é¢„ç®—ç®¡ç†å±‚                                        â”‚
â”‚                                                                                      â”‚
â”‚   2. æ˜¯å¦æ”¯æŒ per-task budgetï¼Ÿ                                                      â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚      âŒ å½“å‰ä¸æ”¯æŒ                                                                   â”‚
â”‚      å·²æœ‰: contextWindow, maxTokens, maxHistoryShare                                 â”‚
â”‚      ç¼ºå¤±: per-task token limit, per-task cost limit                                 â”‚
â”‚      å®ç°éš¾åº¦: ä¸­ (éœ€è¦ä¿®æ”¹ Agent Loop)                                              â”‚
â”‚                                                                                      â”‚
â”‚   3. æ˜¯å¦æ”¯æŒ cost profilingï¼Ÿ                                                       â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚      âœ… åŸºç¡€æ”¯æŒ                                                                     â”‚
â”‚      å·²æœ‰åŠŸèƒ½:                                                                       â”‚
â”‚      - å•æ¬¡/ä¼šè¯/å¤©çº§æˆæœ¬è®¡ç®—                                                        â”‚
â”‚      - æ¨¡å‹/å·¥å…·ä½¿ç”¨åˆ†å¸ƒ                                                             â”‚
â”‚      - Provider è´¦å•å¯¹æ¯”                                                             â”‚
â”‚      - å»¶è¿Ÿç»Ÿè®¡                                                                      â”‚
â”‚      ç¼ºå¤±åŠŸèƒ½:                                                                       â”‚
â”‚      - å®æ—¶æˆæœ¬æµ                                                                    â”‚
â”‚      - æˆæœ¬é¢„æµ‹                                                                      â”‚
â”‚      - å¼‚å¸¸æ£€æµ‹                                                                      â”‚
â”‚                                                                                      â”‚
â”‚   4. æ˜¯å¦å¯åš FinOps ç®¡æ§ï¼Ÿ                                                          â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚      âš ï¸ åŸºç¡€å¯è¡Œï¼Œéœ€å¤§é‡å¼€å‘                                                         â”‚
â”‚      å½“å‰æˆç†Ÿåº¦: L1-L2 (åŸºç¡€æ•°æ®æ”¶é›†)                                                â”‚
â”‚      ç›®æ ‡æˆç†Ÿåº¦: L4 (é¢„æµ‹ã€è‡ªåŠ¨åŒ–ã€æŒç»­ä¼˜åŒ–)                                         â”‚
â”‚      ä¸»è¦å·®è·: é¢„ç®—ç®¡ç†ã€æˆæœ¬é¢„æµ‹ã€å¼‚å¸¸æ£€æµ‹ã€è‡ªåŠ¨åŒ–ä¼˜åŒ–                              â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ”¹è¿›è·¯çº¿å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ”¹è¿›è·¯çº¿å›¾                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   Phase 1: é¢„ç®—åŸºç¡€ (çŸ­æœŸ)                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚   â”œâ”€â”€ 1.1 å®ç° per-session token/cost budget                                         â”‚
â”‚   â”œâ”€â”€ 1.2 æ·»åŠ  budget exceeded å¤„ç†ç­–ç•¥                                              â”‚
â”‚   â”œâ”€â”€ 1.3 å®ç° budget å‘Šè­¦æœºåˆ¶                                                       â”‚
â”‚   â””â”€â”€ 1.4 æ·»åŠ  budget é…ç½®åˆ° config                                                  â”‚
â”‚                                                                                      â”‚
â”‚   Phase 2: Cost Profiling å¢å¼º (ä¸­æœŸ)                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚   â”œâ”€â”€ 2.1 å®ç°å®æ—¶æˆæœ¬äº‹ä»¶æµ                                                         â”‚
â”‚   â”œâ”€â”€ 2.2 æ·»åŠ ç”¨æˆ·/ä»»åŠ¡ç»´åº¦æˆæœ¬åˆ†æ                                                  â”‚
â”‚   â”œâ”€â”€ 2.3 å®ç°æˆæœ¬å¼‚å¸¸æ£€æµ‹                                                           â”‚
â”‚   â””â”€â”€ 2.4 æ·»åŠ æˆæœ¬é¢„æµ‹åŠŸèƒ½                                                           â”‚
â”‚                                                                                      â”‚
â”‚   Phase 3: FinOps ç®¡æ§ (é•¿æœŸ)                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚   â”œâ”€â”€ 3.1 å®ç°å…¨å±€é¢„ç®—ç®¡ç†                                                           â”‚
â”‚   â”œâ”€â”€ 3.2 å®ç°è‡ªåŠ¨æˆæœ¬ä¼˜åŒ–                                                           â”‚
â”‚   â”œâ”€â”€ 3.3 æ·»åŠ  FinOps ä»ªè¡¨ç›˜                                                         â”‚
â”‚   â””â”€â”€ 3.4 å®ç°æ™ºèƒ½æ¨¡å‹é™çº§                                                           â”‚
â”‚                                                                                      â”‚
â”‚   Phase 4: é«˜çº§åŠŸèƒ½ (é•¿æœŸ)                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚   â”œâ”€â”€ 4.1 å¤šç§Ÿæˆ·æˆæœ¬éš”ç¦»                                                             â”‚
â”‚   â”œâ”€â”€ 4.2 æˆæœ¬åˆ†æ‘Šå’Œè®¡è´¹                                                             â”‚
â”‚   â””â”€â”€ 4.3 AI é©±åŠ¨çš„æˆæœ¬ä¼˜åŒ–å»ºè®®                                                      â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | ä¸šåŠ¡ä»·å€¼ | æŠ€æœ¯éš¾åº¦ | ä¾èµ– |
|--------|------|----------|----------|------|
| P0 | Per-session budget | é«˜ | ä¸­ | Agent Loop ä¿®æ”¹ |
| P0 | Budget å‘Šè­¦ | é«˜ | ä½ | äº‹ä»¶ç³»ç»Ÿ |
| P1 | å®æ—¶æˆæœ¬æµ | ä¸­ | ä¸­ | äº‹ä»¶ç³»ç»Ÿå¢å¼º |
| P1 | æˆæœ¬å¼‚å¸¸æ£€æµ‹ | ä¸­ | ä¸­ | å†å²æ•°æ®åˆ†æ |
| P2 | æˆæœ¬é¢„æµ‹ | ä¸­ | é«˜ | æœºå™¨å­¦ä¹  |
| P2 | FinOps ä»ªè¡¨ç›˜ | ä¸­ | ä¸­ | UI å¼€å‘ |
| P3 | è‡ªåŠ¨ä¼˜åŒ– | ä½ | é«˜ | ç­–ç•¥å¼•æ“ |

---

## å‚è€ƒæ–‡æ¡£

- [session-cost-usage.ts](file:///d:/temp/openclaw/src/infra/session-cost-usage.ts)
- [session-cost-usage.types.ts](file:///d:/temp/openclaw/src/infra/session-cost-usage.types.ts)
- [provider-usage.load.ts](file:///d:/temp/openclaw/src/infra/provider-usage.load.ts)
- [usage-format.ts](file:///d:/temp/openclaw/src/utils/usage-format.ts)
- [usage.ts](file:///d:/temp/openclaw/src/agents/usage.ts)
- [compaction.ts](file:///d:/temp/openclaw/src/agents/compaction.ts)
- [types.models.ts](file:///d:/temp/openclaw/src/config/types.models.ts)
- [context.ts](file:///d:/temp/openclaw/src/agents/context.ts)
